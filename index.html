<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Project 2 Title</title>

	<style>

		path.state {
			fill: #ccc;
			stroke: #888;
		}

		circle {
			fill-opacity: .5;
			fill: red;
			stroke: #fff;
			stroke-width: .5px;
		}
	</style>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<link rel="stylesheet" href="styles.css">
</head>

<body>
	<img id="airbnb"
    src="airBNB.svg" 
    alt="AirBnB logo"
    height="43.5px"
    width="50px" />

    <img id="hotelicon"
    src="hotel.svg" 
    alt="hotel icon"
    height="43.5px"
    width="50px" />


	<h1>AIRBNB vs. HOTELS IN MAJOR U.S. CITIES</h1>
	<h2>by Edwin Ma, Michelle Yang, Cynthia Zhu</h2>
	<div id="sliders">Availability (out of 365 days): <input type="range" id="availabilitySlider" min="100" max="365"> Minimum Nights for AirBNB: <input type="range" id="minNightsSlider" min="0" max="8"> Price: <input type="range" id="priceSlider" min="0" max="200"></div>
	<p id="p1"></p>


	<script>
		var width = 800;
		var height = 600;

		// svg element for map of US
		var svg1 = d3.select("#p1")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

		// svg element that's filled when user clicks on circle (shows detailed city information)
		var svg2 = d3.select("#p1")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

		var USAprojection = d3.geoAlbersUsa().scale(75);
		var pathGenerator = d3.geoPath().projection(USAprojection);

		var states;

		// for parsing airBNB data
		var parseRow = function(row) {
			//row.neighbourhood = row.neighbourhood;
			row.latitude = Number(row.latitude);
			row.longitude = Number(row.longitude);
			row.price = Number(row.price);
			row.room_type = row.room_type;
			row.minimum_nights = Number(row.minimum_nights);
			row.availability_365 = Number(row.availability_365);
			return row;
		};

		// global variables for debugging
		var Austin;
		var Boston;
		var Chicago;
		var DC;
		var LA;
		var Nashville;
		var NewOrleans;
		var NYC;
		var Portland;
		var SanDiego;
		var Seattle;
		var SF;
		var hotel; // hotel2016.txt data
		var cities; // array of objects

		d3.queue()
			.defer(d3.json, "us_map.json")
			.defer(d3.csv, "listings_Austin.csv", parseRow)
			.defer(d3.csv, "listings_Boston.csv", parseRow)
			.defer(d3.csv, "listings_Chicago.csv", parseRow)
			.defer(d3.csv, "listings_DC.csv", parseRow)
			.defer(d3.csv, "listings_LA.csv", parseRow)
			.defer(d3.csv, "listings_Nashville.csv", parseRow)
			.defer(d3.csv, "listings_NewOrleans.csv", parseRow)
			.defer(d3.csv, "listings_NYC.csv", parseRow)
			.defer(d3.csv, "listings_Portland.csv", parseRow)
			.defer(d3.csv, "listings_SanDiego.csv", parseRow)
			.defer(d3.csv, "listings_Seattle.csv", parseRow)
			.defer(d3.csv, "listings_SF.csv", parseRow)
			.defer(d3.tsv, "hotel2016.txt")
			.await(function(error, rawMap, rawAustin, rawBoston, rawChicago, rawDC, rawLA, rawNashville, rawNewOrleans, rawNYC, rawPortland, rawSanDiego, rawSeattle, rawSF, rawHotel) {
				states = topojson.feature(rawMap, rawMap.objects.states);
				// the cities, this is for debugging
				Austin = rawAustin;
				Boston = rawBoston;
				hotel = rawHotel;


				USAprojection.fitExtent([
					[0, 0],
					[svg1.attr("width"), svg1.attr("height")]
				], states);
				pathGenerator = d3.geoPath().projection(USAprojection);

				// draw the map
				var paths = svg1.selectAll("path").data(states.features);
				paths.enter().append("path").attr("class", "state")
					.merge(paths)
					.attr("d", function(state) {
						return pathGenerator(state);
					});

				// scales
				var circleScale = d3.scaleSqrt().domain([0, rawBoston.length]).range([0, 10]);

				// city info text element
				var cityInfo = svg1.append("text").
				attr("id", "CityInfo").
				style("font-size", "16pt");

				// cities array
				cities = [{
					name: "Austin",
					longitude: -97.7431,
					latitude: 30.2672,
					variable: rawAustin
				}, {
					name: "Boston",
					longitude: -71.0589,
					latitude: 42.3601,
					variable: rawBoston
				}, {
					name: "Chicago",
					longitude: -87.6298,
					latitude: 41.8781,
					variable: rawChicago
				}, {
					name: "Washington D.C.",
					longitude: -77.0369,
					latitude: 38.9072,
					variable: rawDC
				}, {
					name: "Los Angeles",
					longitude: -118.2437,
					latitude: 34.0522,
					variable: rawBoston
				}, {
					name: "Nashville",
					longitude: -86.7816,
					latitude: 36.1627,
					variable: rawNashville
				}, {
					name: "New Orleans",
					longitude: -90.0715,
					latitude: 29.9511,
					variable: rawNewOrleans
				}, {
					name: "New York City",
					longitude: -74.0059,
					latitude: 40.7128,
					variable: rawNYC
				}, {
					name: "Portland",
					longitude: -122.6765,
					latitude: 45.5231,
					variable: rawPortland
				}, {
					name: "San Diego",
					longitude: -117.1611,
					latitude: 32.7157,
					variable: rawSanDiego
				}, {
					name: "Seattle",
					longitude: -122.3321,
					latitude: 47.6062,
					variable: rawSeattle
				}, {
					name: "San Francisco",
					longitude: -122.4194,
					latitude: 37.7749,
					variable: rawSF
				}];

				// for regex purposes
				var re = /room/;

				// adding attributes to cities programmatically
				for (var i = 0; i < cities.length; i++) {
					cities[i].avgPrice = d3.mean(cities[i].variable, function(d) {
						if ((d.room_type).match(re)) {
							return d.price;
						}
					});

					cities[i].avgMinNights = d3.mean(cities[i].variable, function(d) {
						if ((d.room_type).match(re)) {
							return d.minimum_nights;
						}
					});

					cities[i].avgAvailability = d3.mean(cities[i].variable, function(d) {
						if ((d.room_type).match(re)) {
							return d.availability_365;
						}
					});
				}

				var sliderPrice = 100,
					sliderMinNights = 10,
					sliderAvailability = 182.5;

				// getting slider values
				var priceSlider = d3.select("#priceSlider");
				//console.log("priceSlider:" + priceSlider.value);
				priceSlider.on("input", function() {
					sliderPrice = this.value;
					changeCircles(this);
				});

				var minNightsSlider = d3.select("#minNightsSlider");
				minNightsSlider.on("input", function() {
					sliderMinNights = this.value;
					changeCircles(this);
				});

				var availabilitySlider = d3.select("#availabilitySlider");
				availabilitySlider.on("input", function() {
					sliderAvailability = this.value;
					changeCircles(this);
				});

				// handles circles when slider isn't used

				var selectedCities = cities.filter(function(d) {
					return ((d.avgPrice < (document.getElementById("priceSlider").max + document.getElementById("priceSlider").min) / 2) && (d.avgMinNights < document.getElementById("minNightsSlider").max) && (d.avgAvailability < document.getElementById(
						"availabilitySlider").max));
				});

				var clickedCities = [];

				selectedCities.forEach(function(city) {
					svg1.append("circle")
						.attr("r", circleScale(city.variable.length))
						.attr("cx", USAprojection([city.longitude, city.latitude])[0])
						.attr("cy", USAprojection([city.longitude, city.latitude])[1])
						.on("mouseover", function() {
							svg1.select("#CityInfo").attr("x", USAprojection([city.longitude, city.latitude])[0] - 15)
								.attr("y", USAprojection([city.longitude, city.latitude])[1] - 50)
								.text(city.name + " # of listings" + city.variable.length + " avg. price" + city.avgPrice);
						}).on("click", function() {
							if (clickedCities.indexOf(city) == -1) {
								// add to array if city doesn't already exist
								clickedCities.push(city);
							} else {
								// remove city from array if it already exists
								clickedCities.splice(clickedCities.indexOf(city), 1);
							}

							console.log(clickedCities);
							showCitiesInfo(selectedCities);
							//var paths = svg1.selectAll("path").data(states.features);

						});

				});

				/*
				var circles = svg1.selectAll("circle").data(cities);

				circles.enter().append("circle")
					.attr("r", circleScale(city.variable.length))
					.attr("cx", USAprojection([city.longitude, city.latitude])[0])
					.attr("cy", USAprojection([city.longitude, city.latitude])[1])
					.on("mouseover", function() {
						svg1.select("#CityInfo").attr("x", USAprojection([city.longitude, city.latitude])[0] - 15)
							.attr("y", USAprojection([city.longitude, city.latitude])[1] - 50)
							.text(city.name + " # of listings" + city.variable.length + " avg. price" + city.avgPrice);
					}).on("click", function() {
						console.log(city.name);
						var paths = svg1.selectAll("path").data(states.features);
					});

					*/




				// for changing circles
				function changeCircles(sliderData) {
					// remove and add circles depending on slider's value
					//console.log("value: " + sliderData.value); // gives slider's value
					//console.log("id: " + sliderData.id); // gives slider's id
					// values to filter against

					//var selectedCities;
					/*
					if (sliderData.id == "priceSlider") {
						sliderPrice = sliderData.value;
					} else if (sliderData.id == "minNightsSlider") {
						sliderMinNights = sliderData.value;
					} else if (sliderData.id == "availabilitySlider") {
						sliderAvailability = sliderData.value;
					}
					*/


					console.log("slider:" + sliderData.value);
					var selectedCities = cities.filter(function(d) {
						return ((d.avgPrice < sliderPrice) && (d.avgMinNights < sliderMinNights) && (d.avgAvailability < sliderAvailability));
					});

					console.log(selectedCities);
					svg1.selectAll("circle").remove();

					selectedCities.forEach(function(city) {
						svg1.append("circle")
							.attr("r", circleScale(city.variable.length))
							.attr("cx", USAprojection([city.longitude, city.latitude])[0])
							.attr("cy", USAprojection([city.longitude, city.latitude])[1])
							.on("mouseover", function() {
								svg1.select("#CityInfo").attr("x", USAprojection([city.longitude, city.latitude])[0] - 15)
									.attr("y", USAprojection([city.longitude, city.latitude])[1] - 50)
									.text(city.name + " # of listings" + city.variable.length + " avg. price" + city.avgPrice);
							})
							.on("click", function() {
								showCitiesInfo(selectedCities);
							});

					});

				}

				function showCitiesInfo(cities) {
					// city is an object from the cities array

					//TODO
				}

			});
	</script>

    <div class="credits">Icons made by <a href="http://www.flaticon.com/authors/darius-dan" title="Darius Dan">Darius Dan</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>

    <div class="credits">Icons made by <a href="http://www.flaticon.com/authors/retinaicons" title="Retinaicons">Retinaicons</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>

</body>

</html>
