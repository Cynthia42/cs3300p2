<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Project 2 Title</title>

	<style>
		svg {
			border: solid #ccc 1px;
		}

		path.state {
			fill: #ccc;
			stroke: #888;
		}

		.ticks {
			font: 10px sans-serif;
		}

		.track,
		.track-inset,
		.track-overlay {
			stroke-linecap: round;
		}

		.track {
			stroke: #000;
			stroke-opacity: 0.3;
			stroke-width: 10px;
		}

		.track-inset {
			stroke: #ddd;
			stroke-width: 8px;
		}

		.track-overlay {
			pointer-events: stroke;
			stroke-width: 50px;
			stroke: transparent;
			cursor: crosshair;
		}

		.handle {
			fill: #fff;
			stroke: #000;
			stroke-opacity: 0.5;
			stroke-width: 1.25px;
		}

		circle {
			fill-opacity: .5;
			fill: red;
			stroke: #fff;
			stroke-width: .5px;
		}
	</style>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<link rel="stylesheet" href="styles.css">
</head>

<body>
	<h1>AIRBNB vs. HOTELS IN MAJOR U.S. CITIES</h1>
	<h2>by Edwin Ma, Michelle Yang, Cynthia Zhu</h2>

	<p id="p1">
	</p>

	<script>
		var width = 600;
		var height = 400;
		var svg1 = d3.select("#p1")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

		var svg2 = d3.select("#p1")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

		var USAprojection = d3.geoAlbersUsa().scale(75);
		var pathGenerator = d3.geoPath().projection(USAprojection);

		var states;

		var parseRow = function(row) {
			//row.neighbourhood = row.neighbourhood;
			row.latitude = Number(row.latitude);
			row.longitude = Number(row.longitude);
			row.price = Number(row.price);
			row.room_type = row.room_type;
			row.minimum_nights = Number(row.minimum_nights);
			row.availability_365 = Number(row.availability_365);

			return row;
		};

		var parseHotel = function(row) {
			row.city = row.city
			row.january = Number(row.january.replace("$", ""));
			return row;
		};
		var Austin; // do
		var Boston;
		var Chicago;
		var DC;
		var LA;
		var Nashville; //do
		var NewOrleans;
		var NYC;
		var Portland;
		var SanDiego;
		var Seattle;
		var SF;
		var hotel;
		var cities;

		d3.queue()
			.defer(d3.json, "us_map.json")
			.defer(d3.csv, "listings_Austin.csv", parseRow)
			.defer(d3.csv, "listings_Boston.csv", parseRow)
			.defer(d3.csv, "listings_Chicago.csv", parseRow)
			.defer(d3.csv, "listings_DC.csv", parseRow)
			.defer(d3.csv, "listings_LA.csv", parseRow)
			.defer(d3.csv, "listings_Nashville.csv", parseRow)
			.defer(d3.csv, "listings_NewOrleans.csv", parseRow)
			.defer(d3.csv, "listings_NYC.csv", parseRow)
			.defer(d3.csv, "listings_Portland.csv", parseRow)
			.defer(d3.csv, "listings_SanDiego.csv", parseRow)
			.defer(d3.csv, "listings_Seattle.csv", parseRow)
			.defer(d3.csv, "listings_SF.csv", parseRow)
			.defer(d3.csv, "hotel2016.txt")
			.await(function(error, rawMap, rawAustin, rawBoston, rawChicago, rawDC, rawLA, rawNashville, rawNewOrleans, rawNYC, rawPortland, rawSanDiego, rawSeattle, rawSF, rawHotel) {
				states = topojson.feature(rawMap, rawMap.objects.states);
				// the cities, this is for debugging
				Austin = rawAustin;
				Boston = rawBoston;
				hotel = rawHotel;

				USAprojection.fitExtent([
					[0, 0],
					[svg1.attr("width"), svg1.attr("height")]
				], states);
				pathGenerator = d3.geoPath().projection(USAprojection);

				// draw the map
				var paths = svg1.selectAll("path").data(states.features);
				paths.enter().append("path").attr("class", "state")
					.merge(paths)
					.attr("d", function(state) {
						return pathGenerator(state);
					});

				// scales
				var circleScale = d3.scaleSqrt().domain([0, rawBoston.length]).range([0, 10]);

				// city info text
				var cityInfo = svg1.append("text").
				attr("id", "CityInfo").
				style("font-size", "16pt");
				// draw the cities

				cities = [{
					name: "Austin",
					longitude: -97.7431,
					latitude: 30.2672,
					variable: rawAustin
				}, {
					name: "Boston",
					longitude: -71.0589,
					latitude: 42.3601,
					variable: rawBoston
				}, {
					name: "Chicago",
					longitude: -87.6298,
					latitude: 41.8781,
					variable: rawChicago
				}, {
					name: "Washington D.C.",
					longitude: -77.0369,
					latitude: 38.9072,
					variable: rawDC
				}, {
					name: "Los Angeles",
					longitude: -118.2437,
					latitude: 34.0522,
					variable: rawBoston
				}, {
					name: "Nashville",
					longitude: -86.7816,
					latitude: 36.1627,
					variable: rawNashville
				}, {
					name: "New Orleans",
					longitude: -90.0715,
					latitude: 29.9511,
					variable: rawNewOrleans
				}, {
					name: "New York City",
					longitude: -74.0059,
					latitude: 40.7128,
					variable: rawNYC
				}, {
					name: "Portland",
					longitude: -122.6765,
					latitude: 45.5231,
					variable: rawPortland
				}, {
					name: "San Diego",
					longitude: -117.1611,
					latitude: 32.7157,
					variable: rawSanDiego
				}, {
					name: "Seattle",
					longitude: -122.3321,
					latitude: 47.6062,
					variable: rawSeattle
				}, {
					name: "San Francisco",
					longitude: -122.4194,
					latitude: 37.7749,
					variable: rawSF
				}];
				// for regex purposes
				var re = /room/;

				// adding attributes to cities
				for (var i = 0; i < cities.length; i++) {
					cities[i].avgPrice = d3.mean(cities[i].variable, function(d) {
						if ((d.room_type).match(re)) {
							return d.price;
						}
					});

					cities[i].avgMinNights = d3.mean(cities[i].variable, function(d) {
						if ((d.room_type).match(re)) {
							return d.minimum_nights;
						}
					});

					cities[i].avgAvailability = d3.mean(cities[i].variable, function(d) {
						if ((d.room_type).match(re)) {
							return d.availability_365;
						}
					});
				}

				console.log(cities);

				cities.forEach(function(city) {
					svg1.append("circle")
						.attr("r", circleScale(city.variable.length))
						.attr("cx", USAprojection([city.longitude, city.latitude])[0])
						.attr("cy", USAprojection([city.longitude, city.latitude])[1])
						.on("mouseover", function() {
							svg1.select("#CityInfo").attr("x", USAprojection([city.longitude, city.latitude])[0] - 15)
								.attr("y", USAprojection([city.longitude, city.latitude])[1] - 50)
								.text(city.name + " # of listings" + city.variable.length + " avg. price" + d3.mean(city.variable, function(d) {
									// only average over the airBNBs for singe rooms
									if ((d.room_type).match(re)) {
										return d.price;
									}
								}));
						}).on("click", function() {
							console.log(city.name);
							var paths = svg1.selectAll("path").data(states.features);

						});

				});
				//TODO: make function called "changeCircle"


				//makeSlider();

				// if priceSlider is used
				var priceSlider = d3.select("#priceSlider");
				priceSlider.on("input", function() {
					changeCircles(this);
					//console.log(value);
				});

				function changeCircles(sliderData) {
					// remove and add circles depending on slider's value
					console.log("value: " + sliderData.value); // gives slider's value
					console.log("id: " + sliderData.id); // gives slider's id
					var selectedCities;
					if (sliderData.id == "priceSlider") {
						selectedCities = cities.filter(function(d) {
							return d.avgPrice < sliderData.value;
						})
						console.log(selectedCities);
					};
					svg1.selectAll("circle").remove();

					selectedCities.forEach(function(city) {
						svg1.append("circle")
							.attr("r", circleScale(city.variable.length))
							.attr("cx", USAprojection([city.longitude, city.latitude])[0])
							.attr("cy", USAprojection([city.longitude, city.latitude])[1])
							.on("mouseover", function() {
								svg1.select("#CityInfo").attr("x", USAprojection([city.longitude, city.latitude])[0] - 15)
									.attr("y", USAprojection([city.longitude, city.latitude])[1] - 50)
									.text(city.name + " # of listings" + city.variable.length + " avg. price" + city.avgPrice);
							})
							.on("click", function() {
								console.log("clicked a thing");
								var paths = svg1.selectAll("path").data(states.features);
							});

					});





				}

				//******Handle clicking************
			});

		/********Slider*********/
	</script>

	<div id="sliders">Price: <input type="range" id="priceSlider" min="0" max="200"></div>

</body>

</html>
